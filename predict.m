function [x,P]= predict (x,P,v,Wn,Q,dt)
%[x,P]= predict (x,P, Vn,Wn,Q,dt);
%
% Inputs:
%   x, P - SLAM state and covariance
%   v, g - control inputs: velocity and gamma (steer angle)
%   Q - covariance matrix for velocity and gamma
%   WB - vehicle wheelbase
%   dt - timestep
%
% Outputs: 
%   xn, Pn - predicted state and covariance
%
% Tim Bailey 2004.

% jacobians   
Gv = eye(13);
Gv(1:3,8:10) = eye(3);

q1 = x(4);
q2 = x(5);
q3 = x(6);
q4 = x(7);

w1 = Wn(1);
w2 = Wn(2);
w3 = Wn(3);

Gv(4:7,11:13) = [ -(dt*q2)/2  -(dt*q3)/2  -(dt*q4)/2
                          (dt*q1)/2  -(dt*q4)/2 (dt*q3)/2
                          (dt*q4)/2 (dt*q1)/2  -(dt*q2)/2
                           -(dt*q3)/2 (dt*q2)/2 (dt*q1)/2];
                       
Gv(4:7,4:7) = [ 1 -(dt*w3)/2  -(dt*w1)/2  -(dt*w2)/2
                      (dt*w3)/2 1 (dt*w1)/2 -(dt*w2)/2
                      (dt*w2)/2 -(dt*w1)/2 1 (dt*w3)/2
                      (dt*w1)/2 (dt*w2)/2 -(dt*w3)/2 1];

Gu = [dt*(q1^2/(q1^2 + q2^2 + q3^2 + q4^2) + q2^2/(q1^2 + q2^2 + q3^2 + q4^2) - q3^2/(q1^2 + q2^2 + q3^2 + q4^2) - q4^2/(q1^2 + q2^2 + q3^2 + q4^2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0;
                                                             dt*((2*q1*q4)/(q1^2 + q2^2 + q3^2 + q4^2) + (2*q2*q3)/(q1^2 + q2^2 + q3^2 + q4^2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0;
                                                            -dt*((2*q1*q3)/(q1^2 + q2^2 + q3^2 + q4^2) - (2*q2*q4)/(q1^2 + q2^2 + q3^2 + q4^2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0;
                                                                                                                                              0, (dt^3*w1^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q4))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^2*q1*w1*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) - (dt^3*w1^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q4))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q4))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^3*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q3))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q3))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2), (dt^3*w2^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q3))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^2*q1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) - (dt^3*w2^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q3))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q3))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^3*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q4))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q4))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2), (dt^3*w3^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^2*q1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) - (dt^3*w3^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^3*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q4))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q3))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q4))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2)*conj(q3))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2);
                                                                                                                                              0,                                           (dt*q3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^2*q2*w1*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) + (dt^3*q3*w1^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q3*w1^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q1*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q4*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q4*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2),                                           (dt^3*q4*w2^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^2*q2*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) - (dt^3*q4*w2^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt*q4*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) + (dt^3*q1*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*q3*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^3*q3*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2),                                           (dt*q1*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^2*q2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) + (dt^3*q1*w3^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w3^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q3*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q4*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q3*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q4*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2);
                                                                                                                                              0,                                           (dt^3*q2*w1^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^2*q3*w1*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) - (dt^3*q2*w1^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt*q2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) + (dt^3*q1*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*q4*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^3*q4*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2),                                           (dt*q1*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^2*q3*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) + (dt^3*q1*w2^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w2^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^3*q2*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*q4*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*q2*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^3*q4*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2),                                           (dt*q4*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^2*q3*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) + (dt^3*q4*w3^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q4*w3^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q1*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q2*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q2*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2);
                                                                                                                                              0,                                           (dt*q1*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^2*q4*w1*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) + (dt^3*q1*w1^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w1^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q2*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q3*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q2*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q3*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2),                                           (dt*q2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) - (dt^2*q4*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) + (dt^3*q2*w2^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q2*w2^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q1*w1*w2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q3*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w1*w2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) + (dt^3*q3*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2),                                           (dt^3*q3*w3^2*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^2*q4*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)) - (dt^3*q3*w3^2*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt*q3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2) + (dt^3*q1*w1*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) + (dt^3*q2*w2*w3*cos((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(2*(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)) - (dt^3*q1*w1*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2) - (dt^3*q2*w2*w3*sin((dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(1/2)/2))/(dt^2*w1^2 + dt^2*w2^2 + dt^2*w3^2)^(3/2);
      q1^2/(q1^2 + q2^2 + q3^2 + q4^2) + q2^2/(q1^2 + q2^2 + q3^2 + q4^2) - q3^2/(q1^2 + q2^2 + q3^2 + q4^2) - q4^2/(q1^2 + q2^2 + q3^2 + q4^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0;
                                                                  (2*q1*q4)/(q1^2 + q2^2 + q3^2 + q4^2) + (2*q2*q3)/(q1^2 + q2^2 + q3^2 + q4^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0;
                                                                  (2*q2*q4)/(q1^2 + q2^2 + q3^2 + q4^2) - (2*q1*q3)/(q1^2 + q2^2 + q3^2 + q4^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0;
                                                                                                                                              0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                1;
                                                                                                                                              0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                1,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0;
                                                                                                                                              0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                1,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0];

                         
% % predict covariance
P(1:13,1:13)= Gv*P(1:13,1:13)*Gv' + Gu*Q*Gu';
if size(P,1)>13
    P(1:13,14:end)= Gv*P(1:13,14:end);
    P(14:end,1:13)= P(1:13,14:end)';
end    

% predict state

dcm = quat2dcm(x(4:7)');
x(1:3) = x(1:3)+([v,0,0]*dcm)'.*dt;

x(4:7)= mrotate_eml(x(4:7)', [Wn(3),Wn(2),Wn(1)],dt);

x(8:10) = [v,0,0]*dcm;

x(11:13) = [Wn(3),Wn(2),Wn(1)];


 

